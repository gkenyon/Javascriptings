<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>IIIF Compariscope</title>
    <style type="text/css">
        html, body { height:100%; margin:0; }
        body { background:#333; color:#000; font:14px/1 helvetica,arial,freesans,sans-serif; }
        #compariscope { background:#aaa; display:block; height:400px; width:400px; margin:20px auto; overflow:hidden; position:relative; resize:both; }
        #compariscope img { cursor:pointer; position:absolute; left:0; top:0; }
        #compariscope::after { content:"‚ùñ"; cursor:pointer; font-size:23px; background:green; line-height:20px; height:20px; width:20px; position:absolute; bottom:0; right:0; }
        .cs-ctrl { width:400px; margin:0 auto 20px; }
        #cs-iiif-src { box-sizing:border-box; display:inline-block; padding:4px; height:24px; width:calc(100% - 40px); }
        #cs-img-add { background:green; border-radius:50%; cursor:pointer; display:inline-block; font-size:20px; font-weight:600; height:24px; line-height:24px; margin-left:10px; text-align:center; width:24px; vertical-align:middle; }
        #cs-img-add:active { position:relative; left:1px; top:1px; }
        #cs-fader { border-radius:50%; width:100%; }
    </style>	
</head>

<body>
<div id="compariscope"></div>
<div class="cs-ctrl">
    <input type="range" id="cs-fader" value="0" step=".01">
</div>
<div class="cs-ctrl">
    <input id="cs-iiif-src">
    <a id="cs-img-add">+</a>
</div>
<!--
<img src="img/liam_st_paul/pure_028.jpg" alt=""><img src="img/liam_st_paul/pure_034.jpg" alt=""><img src="img/liam_st_paul/pure_079.jpg" alt="">
<img src="https://framemark.vam.ac.uk/demo/raphael/RC912749/full/full/!0/default.jpg" alt=""><img src="https://framemark.vam.ac.uk/demo/raphael/2006AN5938/full/full/!0/default.jpg" alt=""><img src="https://framemark.vam.ac.uk/demo/raphael/INV43867/full/full/0/default.jpg" alt=""><img src="https://framemark.vam.ac.uk/demo/raphael/2010EJ0404/full/full/0/default.jpg" alt="">
<img src="https://framemark.vam.ac.uk/demo/constable/2010EF0301/full/full/0/default.jpg" alt=""><img src="https://framemark.vam.ac.uk/demo/constable/2010EG9859/full/full/0/default.jpg" alt=""><img src="https://framemark.vam.ac.uk/demo/constable/2010EH2616/full/full/0/default.jpg" alt=""><img src="https://framemark.vam.ac.uk/demo/constable/2010EH2617/full/full/0/default.jpg" alt=""><img src="https://framemark.vam.ac.uk/demo/constable/N1207/full/full/0/default.jpg" alt="">
-->

<script type="text/javascript">
(function(){
    function getComputed(el,style){ var s; if( style=='width' ){ s=el.getBoundingClientRect().right-el.getBoundingClientRect().left; }else if( style=='height' ){ s=el.getBoundingClientRect().bottom-el.getBoundingClientRect().top }else if(window.getComputedStyle){ s=document.defaultView.getComputedStyle(el,null).getPropertyValue(style); }else if(el.currentStyle){ s=el.currentStyle[style] } return parseFloat(s); }
    function getPgOffset(el){ var o=[0,0]; if( el.offsetParent ){ do{ o=[o[0]+el.offsetLeft,o[1]+el.offsetTop]; }while( el=el.offsetParent ) } return [o[0]+document.body.scrollLeft,o[1]+document.body.scrollTop]; } 
    function getXY(e){ var xy=[]; if( e.touches && e.touches.length ){ if( e.touches.length>1 ){ xy[0] = (e.touches[0].pageX+e.touches[0].pageX)/2; xy[1] = (e.touches[0].pageY+e.touches[0].pageY)/2;}else{ xy[0] = e.touches[0].pageX; xy[1] = e.touches[0].pageY; } }else{ xy[0] = e.pageX; xy[1] = e.pageY; } return xy; }

    var compariscope = document.getElementById('compariscope'),
        fader = document.getElementById('cs-fader'),
        imgSrc = document.getElementById('cs-iiif-src'),
        imgAdd = document.getElementById('cs-img-add'),
        img,
        imgs = [];
    
    imgAdd.onclick = function(e){ 
        img = new Image();
        img.src = imgSrc.value;
        img.onload = function() {
            compariscope.appendChild(this);
            dragZoom.init(this, {'zoom':1});
        }
        imgs.push(img);
    };

    function reCentre(){
        var el, i;
        for( i=0; i<imgs.length; ++i ){
            el = imgs[i];
            dragZoom.size(el);
            el.xyP = getPgOffset(el.P);
            el.move([el.xy[0]+((el.whP[0]-el.whP0[0])/2), el.xy[1]+((el.whP[1]-el.whP0[1])/2)]);
            el.whP0 = el.whP;
        }
    }

    compariscope.onmousemove = function(e){ 
        if(e.target === this){
            window.requestAnimationFrame(function(){ reCentre() });
        }
    };
    
    function csFade(x){
        window.requestAnimationFrame(function(){ 
            console.log(x);
        });
    }

    fader.oninput = function(e){ 
        csFade(e.target.value);
    };
    
    var dragZoom = {
        el:null, xy0:null, v0:null, xyT:null, xyE:null, d0:null, 
        size: function(el){
            el.wh = [getComputed(el,'width'), getComputed(el,'height')];
            el.whP = [getComputed(el.P,'width'), getComputed(el.P,'height')];
            el.xyP = getPgOffset(el.P);
            el.hv = el.wh[0]>el.wh[1]? 0 : 1;
        },
        init: function(el, opt){
            if( typeof el==='string' ){ el = document.querySelector(el); } if( !el ){ return; }
            if( !opt ) var opt = {};
            el.zoomer = !!opt.zoom? opt.zoom : 0;
            el.P = el.parentNode;
            dragZoom.size(el);
            el.xy = [getComputed(el,'left'), getComputed(el,'top')];
            el.v = [0,0];
            if( !el.move ){
                el.whP0 = el.whP;
                el.onmousedown = dragZoom.touch;
                el.ontouchstart = dragZoom.touch;
                if( window.addEventListener ){
                    el.addEventListener('DOMMouseScroll', dragZoom.touch, false); 
                    el.addEventListener('mousewheel', dragZoom.touch, false); 
                }else if( window.attachEvent ){
                    el.attachEvent('onmousewheel', dragZoom.touch);
                }
                el.move = function(xy){
                    var my=this, x=xy[0], y=xy[1], r;
                    window.requestAnimationFrame(function(){ 
                        if( my.wh[0]>my.whP[0] ){
                            if( x>0 ){ x=0; r=my.wh[0]>my.whP[0]?[1,0]:null; }
                            else if( x<my.whP[0]-my.wh[0] ){ x=my.whP[0]-my.wh[0]; r=my.wh[0]>my.whP[0]?[-1,0]:null; }
                            my.style.left = x+'px';
                        }
                        if( my.wh[1]>my.whP[1] ){
                            if( y>0 ){ y=0; r=my.wh[1]>my.whP[1]?[0,1]:r; }
                            else if( y<my.whP[1]-my.wh[1] ){ y=my.whP[1]-my.wh[1]; r=my.wh[1]>my.whP[1]?[0,-1]:r; }
                            my.style.top = y+'px';
                        }
                        my.xy = [x,y];
                        return r || null;
                    });
                };
                el.drop = typeof(opt.drop)==='function'? opt.drop : function(){
                    var f = Math.abs(this.v[0])+Math.abs(this.v[1])>50?0.98:0.90, r;
                    this.v = [this.v[0]*f, this.v[1]*f];
                    var r = this.move([this.xy[0]+this.v[0], this.xy[1]+this.v[1]]);
                    if( r || Math.abs(this.v[0])+Math.abs(this.v[1])<0.5 ){
                        dragZoom.v0=this.v=[0,0]; window.clearTimeout(this.t); 
                        return;
                    }
                    this.t = window.setTimeout(function(){ el.drop(); }, 23);
                };
                if( el.zoomer ){
                    el.wMax = el.getAttribute('data-max-width');
                    el.zoom = function(z,xy0){
                        xy0 = xy0 || [this.whP[0]/2, this.whP[1]/2];
                        if( this.wh[0]*z>this.whP[0] || this.wh[1]*z>this.whP[1] ){
                            this.wh = [this.wh[0]*z,this.wh[1]*z];
                            this.style.width = this.wh[0]+'px';
                            this.style.height = this.wh[1]+'px';
                            this.move([(xy0[0]-((xy0[0]-this.xy[0])*z)),(xy0[1]-((xy0[1]-this.xy[1])*z))]);
                        }
                    };
                }
            }
        },
        touch: function(e){
            e = e || window.event;
            if( e.type==='touchstart' && e.touches && e.touches.length>2 ){ return; }
            dragZoom.el = this;
            window.clearTimeout(dragZoom.el.t);
            dragZoom.v0 = dragZoom.el.v;
            dragZoom.el.v = [0,0];
            dragZoom.xy0 = dragZoom.el.xy;
            dragZoom.xyT = getXY(e);
            if( e.type==='touchstart' ){
                if( dragZoom.el.zoomer && e.touches && e.touches.length===2 ){
                    dragZoom.d0 = Math.sqrt(Math.pow(e.touches[0].pageX-e.touches[1].pageX,2)+Math.pow(e.touches[0].pageY-e.touches[1].pageY,2));
                    dragZoom.el.ontouchmove = dragZoom.zoom;
                }else{
                    dragZoom.el.ontouchmove = dragZoom.drag;
                }
                dragZoom.el.onmousedown = null;
                dragZoom.el.ontouchend = function(){
                    dragZoom.el.ontouchmove = null;
                    dragZoom.el.ontouchend = null;
                    dragZoom.release();
                };
            }else{
                if( e.type==='DOMMouseScroll' || e.type==='mousewheel' ){
                    if( dragZoom.el.zoomer ){ dragZoom.zoom(e); }
                }else{
                    document.onmousemove = dragZoom.drag;
                    document.onmouseup = function(){
                        document.onmousemove = null;
                        document.onmouseup = null;
                        dragZoom.release();
                    };
                }
            }
            return false;
        },
        drag: function(e){
            e = e || window.event;
            dragZoom.xyE = getXY(e);
            var xy = [dragZoom.xy0[0]+dragZoom.xyE[0]-dragZoom.xyT[0], dragZoom.xy0[1]+dragZoom.xyE[1]-dragZoom.xyT[1]];
            dragZoom.el.v = [xy[0]-dragZoom.el.xy[0],xy[1]-dragZoom.el.xy[1]];
            dragZoom.el.move(xy);
            return false;
        },
        release: function(){
            var vmax = 100;
            dragZoom.el.v = [dragZoom.el.v[0]>vmax?vmax:dragZoom.el.v[0],dragZoom.el.v[1]>vmax?vmax:dragZoom.el.v[1]];
            dragZoom.el.drop();
            dragZoom.el = dragZoom.xyE = dragZoom.d0 = null;
        },
        zoom: function(e){
            e = e || window.event;
            if( e.preventDefault ){ e.preventDefault(); }else{ e.returnValue=false; }
            var z, d1, xy0 = [dragZoom.xyT[0]-dragZoom.el.xyP[0],dragZoom.xyT[1]-dragZoom.el.xyP[1]];
            if( e.touches ){
                d1 = Math.sqrt(Math.pow(e.touches[0].pageX-e.touches[1].pageX,2)+Math.pow(e.touches[0].pageY-e.touches[1].pageY,2));
                z = 1+((d1-dragZoom.d0>0?(d1/dragZoom.el.whP[0]):-0.5)*0.1);
                dragZoom.d0 = d1;
            }else{
                z = (e.detail? e.detail*-1 : e.wheelDelta/40);
                z = 1+((z>0?1:-1)*0.25);
            }
            dragZoom.el.zoom(z,xy0);
            return false;
        }
    };
})();
</script>
</body>
</html>
