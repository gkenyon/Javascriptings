<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>IIIF Compariscope</title>
    <style type="text/css">
        html, body, #cs-wrapper { height:100%; margin:0; }
        body { background:#333; color:#000; font:10px/1 courier,monospace; }
        .compariscope { margin:20px auto; overflow:hidden; position:relative; }
        .compariscope img { position:absolute; left:0; top:0; user-select:none; }
        #cs-editor { background:#fff url(img/compariscope/cross-hairs.png) 50% 50% no-repeat; outline:2px dashed #f54007; height:400px; width:400px; resize:both; }
        #cs-editor::after { content:"❖"; cursor:pointer; font-size:20px; background:#f54007; line-height:16px; height:16px; width:16px; text-align:center; position:absolute; bottom:0; right:0; }
        #cs-editor img { cursor:pointer; outline:2px solid #f54007; }
        #cs-viewer img { height:auto; width:100%; }
        #cs-viewer, 
        .cs-preview #cs-editor { display:none; }
        .cs-preview #cs-viewer { display:block; }
        .cs-ctrl { width:600px; max-width:90%; margin:0 auto 20px; text-align:center; }
        .cs-btn { background:#f54007; border-radius:10px; box-shadow:inset 0 0 2px #000; cursor:pointer; display:inline-block; font-size:20px; font-weight:600; height:24px; line-height:24px; text-align:center; width:24px; vertical-align:middle; }
        .cs-btn:active { position:relative; left:1px; top:1px; }
        .cs-btn.active { background:#000; color:#f54007; }
        .cs-preview #cs-img-add, .cs-preview #cs-img-remove { visibility:hidden; }
        #cs-iiif-src { border:0; box-sizing:border-box; display:inline-block; padding:4px; height:24px; width:calc(100% - 160px); text-align:right; }
        #cs-fader, #cs-range { width:100%; }
        #cs-range { background:#fff; }
        #cs-range div { border-right:1px solid #fff; box-sizing:border-box; color:#f54007; float:left; font-weight:600; padding-right:4px; text-align:right; }
        #cs-mode { padding:0 10px; width:auto; }
        #cs-mode::after { content:'Preview'; }
        .cs-preview #cs-mode::after { content:'Edit'; }
    </style>	
</head>

<body>
<div id="cs-wrapper">
    <style id="cs-css"></style>
    <div class="compariscope" id="cs-editor"></div>
    <div class="compariscope" id="cs-viewer"></div>
    <div class="cs-ctrl">
        <div id="cs-range"></div>
        <input type="range" id="cs-fader" value="1" max="1" step=".01">
    </div>
    <div class="cs-ctrl">
        <input id="cs-iiif-src">
        <a class="cs-btn" id="cs-img-add" title="Add layer">+</a>
        <a class="cs-btn" id="cs-img-remove" title="Remove current layer">-</a>
        <a class="cs-btn" id="cs-img-shift" title="Raise current layer">></a>
        <a class="cs-btn" id="cs-img-lock" title="Lock all layers">₪</a>
        <a class="cs-btn" id="cs-img-snap" title="Crop to current layer">☐</a>
    </div>
    <div class="cs-ctrl">
        <a class="cs-btn" id="cs-mode"></a>
    </div>
</div>
<!--
http://framemark.int.vam.ac.uk/demo/raphael/RC912749/full/full/!0/default.jpg
http://framemark.int.vam.ac.uk/demo/raphael/2006AN5938/full/full/!0/default.jpg
http://framemark.int.vam.ac.uk/demo/raphael/INV43867/full/full/0/default.jpg
http://framemark.int.vam.ac.uk/demo/raphael/2010EJ0404/full/full/0/default.jpg

http://framemark.int.vam.ac.uk/demo/constable/2010EF0301/full/full/0/default.jpg
http://framemark.int.vam.ac.uk/demo/constable/2010EG9859/full/full/0/default.jpg
http://framemark.int.vam.ac.uk/demo/constable/2010EH2616/full/full/0/default.jpg
http://framemark.int.vam.ac.uk/demo/constable/2010EH2617/full/full/0/default.jpg
http://framemark.int.vam.ac.uk/demo/constable/N1207/full/full/0/default.jpg

http://framemark.int.vam.ac.uk/demo/muybridge/2006BC5159/full/full/0/default.jpg
http://framemark.int.vam.ac.uk/demo/muybridge/2008BV6117/full/full/0/default.jpg

http://framemark.int.vam.ac.uk/collections/2013GC0441/full/full/0/default.jpg
https://images.britishart.yale.edu/iiif/745550dc-83ed-4a23-8dab-fde3532741f9/full/full/0/native.jpg

http://framemark.int.vam.ac.uk/demo/balenciaga/2017JW7425/full/full/0/default.jpg
http://framemark.int.vam.ac.uk/demo/balenciaga/2017JT3719/full/full/0/default.jpg
-->

<script type="text/javascript">
(function(){
    function getComputed(el,style){ var s; if( style=='width' ){ s=el.getBoundingClientRect().right-el.getBoundingClientRect().left; }else if( style=='height' ){ s=el.getBoundingClientRect().bottom-el.getBoundingClientRect().top }else if(window.getComputedStyle){ s=document.defaultView.getComputedStyle(el,null).getPropertyValue(style); }else if(el.currentStyle){ s=el.currentStyle[style] } return parseFloat(s); }
    function getPgOffset(el){ var o=[0,0]; if( el.offsetParent ){ do{ o=[o[0]+el.offsetLeft,o[1]+el.offsetTop]; }while( el=el.offsetParent ) } return [o[0]+document.body.scrollLeft,o[1]+document.body.scrollTop]; } 
    function getXY(e){ var xy=[]; if( e.touches && e.touches.length ){ if( e.touches.length>1 ){ xy[0] = (e.touches[0].pageX+e.touches[0].pageX)/2; xy[1] = (e.touches[0].pageY+e.touches[0].pageY)/2;}else{ xy[0] = e.touches[0].pageX; xy[1] = e.touches[0].pageY; } }else{ xy[0] = e.pageX; xy[1] = e.pageY; } return xy; }

    var compariscope = document.getElementById('cs-editor'),
        viewer = document.getElementById('cs-viewer'),
        wrapper = document.getElementById('cs-wrapper'),
        css = document.getElementById('cs-css'),
        fader = document.getElementById('cs-fader'),
        range = document.getElementById('cs-range'),
        imgSrc = document.getElementById('cs-iiif-src'),
        imgAdd = document.getElementById('cs-img-add'),
        imgRemove = document.getElementById('cs-img-remove'),
        imgShift = document.getElementById('cs-img-shift'),
        imgLock = document.getElementById('cs-img-lock'),
        imgSnap = document.getElementById('cs-img-snap'),
        mode = document.getElementById('cs-mode');
    compariscope.imgs = [];
    compariscope.css = css;
    compariscope.style.height = '60%'; 
    compariscope.style.width = getComputed(compariscope,'height')+'px';  

    compariscope.reCentre = function(){
        var el, i,
            xyP = getPgOffset(this);
            //~ shiftImgs = 1;
        //~ for( i=0; i<this.imgs.length; ++i ){
            //~ el = this.imgs[i];
            //~ if( el.wh[0]<el.whP[0] || el.wh[1]<el.whP[1] || el.edged ){
                //~ shiftImgs = 0;
                //~ break;
            //~ }
        //~ }
        for( i=0; i<this.imgs.length; ++i ){
            el = this.imgs[i];
            dragZoom.size(el);
            el.xyP = xyP;
            //~ if( shiftImgs ){
                el.move([el.xy[0]+((el.whP[0]-el.whP0[0])/2), el.xy[1]+((el.whP[1]-el.whP0[1])/2)]);
            //~ }
            el.whP0 = el.whP;
        }
    }

    compariscope.fade = function(x){
        var arcs = this.imgs.length,
            vis = Math.ceil(x*arcs),
            opacity = (x%(1/arcs))*arcs;
        if( (opacity===0 && x>0) || (x===1 && opacity!==1) ) opacity = 1;
        this.css.innerHTML = ' \
            .compariscope :nth-child(-n+'+vis+'){ opacity:1 } \
            .compariscope :nth-child(n+'+(vis+1)+'){ opacity:0; z-index:-999 } \
            .compariscope :nth-child('+vis+'){ opacity:'+opacity+' } \
            ';
        if(vis>0) imgSrc.value = this.imgs[vis-1].src;
        fader.value = x;
    }

    compariscope.range = function(){
        var arcs = this.imgs.length,
            rangeHTML = '';
        for( i=1; i<=arcs; ++i ){
            rangeHTML += '<div style="width:'+(100/arcs)+'%">'+i+'</div>';
        }
        range.innerHTML = rangeHTML;
    }

    compariscope.onmousedown = function(e){ 
        if( e.target === this ) this.rsReset = 1;
    };

    compariscope.onmousemove = function(e){ 
        if( e.target === this ){
            if( this.rsReset ){
                this.rsReset = 0;
                setTimeout(function(){ compariscope.style.width = '10px'; compariscope.style.height = '10px'; }, 0);
            }
            window.requestAnimationFrame(function(){ compariscope.reCentre() });
        }
    };

    imgAdd.onclick = function(e){ 
        var img = document.createElement('img');
        img.src = imgSrc.value;
        compariscope.appendChild(img);
        img.onload = function() {
            if( compariscope.imgs.length===1 ){ 
                compariscope.style.width = getComputed(compariscope,'height') * this.naturalWidth/this.naturalHeight+'px';  
            }
            if( this.naturalWidth > this.naturalHeight ){
                this.style.width = 'auto'; this.style.height = '100%';
            }else{
                this.style.width = '100%'; this.style.height = 'auto';
            }
            setTimeout(function(){ dragZoom.init(img, {'zoom':1, 'siblings':compariscope.imgs}) }, 0);
            compariscope.fade(1);
        }
        compariscope.imgs.push(img);
        compariscope.range();
    };

    imgShift.onclick = function(e){
        var i = Math.round(fader.value*compariscope.imgs.length - 1),
            img = compariscope.imgs[i];
        compariscope.imgs[i] = img.nextSibling;
        compariscope.imgs[i+1] = img;
        compariscope.insertBefore(img.nextSibling, img);
        compariscope.fade(parseFloat(fader.value) + (1/compariscope.imgs.length));
    };

    imgRemove.onclick = function(e){
        var i = Math.round(fader.value*compariscope.imgs.length - 1);
        compariscope.removeChild(compariscope.imgs[i]);
        compariscope.fade(1);
        compariscope.imgs.splice(i, 1);
        compariscope.range();
    };

    imgLock.onclick = function(e){
        this.classList.toggle('active');
        for( i=0; i<compariscope.imgs.length; ++i ){
            compariscope.imgs[i].lock = this.classList.contains('active') ? true : false;
        }
    };

    imgSnap.onclick = function(e){
        var i = Math.round(fader.value*compariscope.imgs.length - 1),
            img = compariscope.imgs[i];
        compariscope.style.width = img.wh[0]+'px'; compariscope.style.height = img.wh[1]+'px';
        for( i=0; i<compariscope.imgs.length; ++i ){
            dragZoom.size(compariscope.imgs[i]);
        }
        img.lock = 1;
        img.move([0,0]);
        img.lock = 0;
    };

    fader.oninput = function(e){ 
        window.requestAnimationFrame(function(){
            compariscope.fade(e.target.value);
        });
    };

    mode.onclick = function(e){
        var img, i,
            iSrc = html = '';
        for( i=0; i<compariscope.imgs.length; ++i ){
            img = compariscope.imgs[i];
            if( img.wh[0]<img.whP[0] || img.wh[1]<img.whP[1] ) {
                alert('Each image must be larger or equal to the crop frame');
                return;
            }
            iSrc = img.src.replace('/full/full/', '/pct:'+(-100*img.xy[0]/img.wh[0])+','+(-100*img.xy[1]/img.wh[1])+','+(100*img.whP[0]/img.wh[0])+','+(100*img.whP[1]/img.wh[1])+'/full/');
            html += '<img src="'+iSrc+'">';
        }
        viewer.style.width = (80*parseInt(compariscope.style.width)/parseInt(compariscope.style.height))+'vh';
        viewer.style.height = '80vh';
        viewer.innerHTML = html;
        wrapper.classList.toggle('cs-preview');
    };

    window.onload = function(e){ imgSrc.focus(); }

    var dragZoom = {
        el:null, xy0:null, v0:null, xyT:null, xyE:null, d0:null, 
        size: function(el){
            el.wh = [getComputed(el,'width'), getComputed(el,'height')];
            el.whP = [getComputed(el.P,'width'), getComputed(el.P,'height')];
            el.xyP = getPgOffset(el.P);
            el.style.width = el.wh[0]+'px'; el.style.height = el.wh[1]+'px';
        },
        init: function(el, opt){
            if( typeof el==='string' ){ el = document.querySelector(el); } if( !el ){ return; }
            if( !opt ) var opt = {};
            el.zoomer = opt.zoom || 0;
            el.siblings = opt.siblings || el.parentNode.getElementsByTagName(el.tagName);
            el.P = el.parentNode;
            dragZoom.size(el);
            el.xy = [getComputed(el,'left'), getComputed(el,'top')];
            if( !el.move ){
                el.whP0 = el.whP;
                el.onmousedown = dragZoom.touch;
                el.ontouchstart = dragZoom.touch;
                if( window.addEventListener ){
                    el.addEventListener('DOMMouseScroll', dragZoom.touch, false); 
                    el.addEventListener('mousewheel', dragZoom.touch, false); 
                }else if( window.attachEvent ){
                    el.attachEvent('onmousewheel', dragZoom.touch);
                }
                el.move = function(xy){
                    var x=xy[0], y=xy[1];
                    //~ el.edged=0;
                    //~ if( x>=0 ){ x=0; el.edged=1; }
                    //~ else if( x<this.whP[0]-this.wh[0] ){ x=this.whP[0]-this.wh[0]; el.edged=1; }
                    //~ if( y>=0 ){ y=0; el.edged=1; }
                    //~ else if( y<this.whP[1]-this.wh[1] ){ y=this.whP[1]-this.wh[1]; el.edged=1; }
                    this.style.left = x+'px';
                    this.style.top = y+'px';
                    this.xy = [x,y];
                };
                if( el.zoomer ){
                    el.zoom = function(z){
                        var xy0 = [dragZoom.xyT[0]-dragZoom.el.xyP[0],dragZoom.xyT[1]-dragZoom.el.xyP[1]];
                        this.wh = [this.wh[0]*z,this.wh[1]*z];
                        this.style.width = this.wh[0]+'px';
                        this.style.height = this.wh[1]+'px';
                        if( this.wh[0]>=this.whP[0] && this.wh[1]>=this.whP[1] ){
                            this.move([(xy0[0]-((xy0[0]-this.xy[0])*z)),(xy0[1]-((xy0[1]-this.xy[1])*z))]);
                        }
                    };
                }
            }
        },
        touch: function(e){
            e = e || window.event;
            if( e.type==='touchstart' && e.touches && e.touches.length>2 ){ return; }
            dragZoom.el = this;
            dragZoom.xy0 = dragZoom.el.xy;
            dragZoom.xyT = getXY(e);
            if( e.type==='touchstart' ){
                if( dragZoom.el.zoomer && e.touches && e.touches.length===2 ){
                    dragZoom.d0 = Math.sqrt(Math.pow(e.touches[0].pageX-e.touches[1].pageX,2)+Math.pow(e.touches[0].pageY-e.touches[1].pageY,2));
                    dragZoom.el.ontouchmove = dragZoom.zoom;
                }else{
                    dragZoom.el.ontouchmove = dragZoom.drag;
                }
                dragZoom.el.onmousedown = null;
                dragZoom.el.ontouchend = function(){
                    dragZoom.el.ontouchmove = null;
                    dragZoom.el.ontouchend = null;
                    dragZoom.release();
                };
            }else{
                if( e.type==='DOMMouseScroll' || e.type==='mousewheel' ){
                    if( dragZoom.el.zoomer ){ dragZoom.zoom(e); }
                }else{
                    document.onmousemove = dragZoom.drag;
                    document.onmouseup = function(){
                        document.onmousemove = null;
                        document.onmouseup = null;
                        dragZoom.release();
                    };
                }
            }
            return false;
        },
        drag: function(e){
            e = e || window.event;
            dragZoom.xyE = getXY(e);
            var xy = [dragZoom.xy0[0]+dragZoom.xyE[0]-dragZoom.xyT[0], dragZoom.xy0[1]+dragZoom.xyE[1]-dragZoom.xyT[1]];
            if( dragZoom.el.lock ){
                for( i=0; i<dragZoom.el.siblings.length; ++i ){
                    dragZoom.el.siblings[i].move(xy);
                }
            }else{
                dragZoom.el.move(xy);
            }
            return false;
        },
        release: function(){
            dragZoom.el = dragZoom.xyE = dragZoom.d0 = null;
        },
        zoom: function(e){
            e = e || window.event;
            if( e.preventDefault ){ e.preventDefault(); }else{ e.returnValue=false; }
            var z, d1;
            if( e.touches ){
                d1 = Math.sqrt(Math.pow(e.touches[0].pageX-e.touches[1].pageX,2)+Math.pow(e.touches[0].pageY-e.touches[1].pageY,2));
                z = 1+((d1-dragZoom.d0>0?(d1/dragZoom.el.whP[0]):-0.5)*0.1);
                dragZoom.d0 = d1;
            }else{
                z = (e.detail? e.detail*-1 : e.wheelDelta/40);
                z = 1+((z>0?1:-1)*0.05);
            }
            if( dragZoom.el.lock ){
                for( i=0; i<dragZoom.el.siblings.length; ++i ){
                    dragZoom.el.siblings[i].zoom(z);
                }
            }else{
                dragZoom.el.zoom(z);
            }
            return false;
        }
    };
})();
</script>
</body>
</html>
