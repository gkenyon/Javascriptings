<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>pong</title>
  <style type="text/css">
    html, body { height:100%; margin:0; width:100%; overflow:hidden; }
    body { background:#111; color:#fff; font:42px/1 helvetica,arial,freesans,sans-serif; }
    .hide { display:none; }
    .board { background:#ebd2b4; height:80%; width:80%; position:absolute; left:10%; top:10%; }
    .paddle { background:#fff; border-radius:5%; cursor:pointer; display:block; height:5%; width:20%; position:absolute; left:0; bottom:-2.5%; }
    .puk { background:#603c11; border-radius:50%; cursor:pointer; display:block; height:1em; line-height:1em; width:1em; text-align:center; position:absolute; left:0; top:0; }
    .goal { border-bottom:3px solid #111; border-top:1.5em solid #fff; border-radius:50% 50% 5% 5%; margin:-1.5em auto 0; width:25%; }
    .scores { display:table; height:10%; margin:0 auto; width:90%; }
    .score { display:table-cell; vertical-align:middle; }
  </style>
</head>

<body>
  <div class="board" id="board">
    <div class="paddle" id="paddle"></div>
    <div class="puk" id="puk"></div>
    <div class="goal" id="goal"></div>
  </div>
  <div class="scores"><div class="score" id="s1"></div></div>

<script type="text/javascript">
function addHandler(el,evt,fn){ if( el.addEventListener ){ el.addEventListener(evt,fn,false); }else if( el.attachEvent ){ el.attachEvent('on'+evt,fn); } }
function getComputed(el,style){ if(window.getComputedStyle){ var y=document.defaultView.getComputedStyle(el,null).getPropertyValue(style); }else if(el.currentStyle){ if( style=='width' ){ y=el.getBoundingClientRect().right-el.getBoundingClientRect().left }else if( style=='height' ){ y=el.getBoundingClientRect().bottom-el.getBoundingClientRect().top }else{ var y=el.currentStyle[style] } } return parseFloat(y); }
function getPgOffset(el){ var o=[0,0]; if( el.offsetParent ){ do{ o=[o[0]+el.offsetLeft,o[1]+el.offsetTop]; }while( el=el.offsetParent ) } return [o[0]+document.body.scrollLeft,o[1]+document.body.scrollTop]; } 
function getX(e){ var x=null; if( e.touches && e.touches.length ){ if( e.touches.length>1 ){ x = (e.touches[0].pageX+e.touches[0].pageX)/2; }else{ x = e.touches[0].pageX; } }else{ x = e.pageX; } return x; }
var pong;
pong = {
  init: function(){
    var board = document.getElementById('board'),
      goal = document.getElementById('goal');
    pong.wh = [getComputed(board,'width'), getComputed(board,'height')];
    document.body.style.fontSize = pong.wh[1]/14+'px';
    pong.goal = [(pong.wh[0]/2)-(getComputed(goal,'width')/2), (pong.wh[0]/2)+(getComputed(goal,'width')/2)];
    pong.paddle = pong.paddleInit(document.getElementById('paddle'));
    pong.puk = pong.pukInit(document.getElementById('puk'));
    pong.obs=[];
	},
	pukReset: function(el){ 
    clearTimeout(el.t);
    el.wh = [getComputed(el,'width'), getComputed(el,'height')];
    el.xy = [getComputed(el,'left'), getComputed(el,'top')];
    el.v = [0,0];
    el.out = 0;
  },
  pukInit: function(el){
    pong.pukReset(el);
    if( !el.move ){
      el.throws = el.goals = 0;
      el.move = function(xy){
        var x=xy[0], y=xy[1], r;
        if( !this.out ){
          if( x<=0 ){ x=0; r=[-1,0]; }
          else if( x>=pong.wh[0]-this.wh[0] ){ x=pong.wh[0]-this.wh[0]; r=[1,0]; }
          if( y>=pong.wh[1]-this.wh[1] ){ 
            if( x>pong.paddle[0] && x<pong.paddle[1]-this.wh[0] ){ this.out=1; if( this.id==='puk' ){ pong.el.goals++ }else if( this===pong.el ){ pong.el.goals-- } pong.scores(); setTimeout(function(){pong.init()},1000) }
            else{ this.out=1; pong.el.goals--; pong.scores(); setTimeout(function(){pong.init()},1000) }
          }
          else if( y<=0 ){
            if( x>pong.goal[0] && x<pong.goal[1]-this.wh[0] ){ this.out=1; pong.el.goals++; pong.scores(); setTimeout(function(){pong.init()},1000) }
            else{ y=0; r=[0,-1]; }
          }
          for( var o in pong.obs ){
            if( Math.abs(x-pong.obs[o].xy[0])<this.wh[0] && Math.abs(y-pong.obs[o].xy[1])<this.wh[1] ){
              //~ this.v = [vt1[0]+vn2[0], vt1[1]+vn2[1]];
              //~ clearTimeout(pong.obs[o].t); 
              //~ pong.obs[o].v = [vt2[0]+vn1[0], vt2[1]+vn1[1]];
              //~ pong.obs[o].drop();
            }
          }
        }
        this.xy = [x,y];
        this.style.left = x+'px';
        this.style.top = y+'px';
        return r;
      };
      el.drop = function(){
        var f = 1, r;
        this.v = [this.v[0]*f, this.v[1]*f]; //v=u+at
        r = this.move([this.xy[0]+this.v[0], this.xy[1]+this.v[1]]);
        if( r ){
          if( r[0] ){ this.v = [-this.v[0], this.v[1]]; }
          if( r[1] ){ this.v = [this.v[0], -this.v[1]]; }
        }
        if( Math.abs(this.v[0])+Math.abs(this.v[1]) < 0.5 ){ clearTimeout(this.t); return; }
        this.t = setTimeout(function(){ el.drop(); }, 23);
        return false;
      };
    }
    return el;
	},
	paddleReset: function(el){ 
    el.w = getComputed(el,'width');
    el.x = getComputed(el,'left');
  },
  paddleInit: function(el){
    pong.paddleReset(el);
    if( !el.move ){
      el.move = function(x){
        if( !this.out ){
          if( x<=0 ){ x=0; }
          else if( x>=pong.wh[0]-this.w ){ x=pong.wh[0]-this.w; }
        }
        this.x = x;
        this.style.left = x+'px';
      };
      el.onmousemove = el.ontouchmove = pong.touch;
    }
    return el;
	},
	touch: function(e){
		e = e || window.event;
		pong.paddle.move(getX(e));
	},
	release: function(){
    pong.el.drop();
    pong.scores();
	},
	scores: function(zero){
    var p1 = document.getElementById('p1'),
        s1 = document.getElementById('s1');
    p1.throws++;
    if( !!zero ){
      p1.throws = p1.goals = 0;
      s1.innerHTML = '';
    }else{
      s1.innerHTML = p1.goals+'/'+p1.throws;
    }
  }
};

pong.init();
addHandler(window,'resize',function(){
  pong.init(); 
});
</script>
</body>
</html>
