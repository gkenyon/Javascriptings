<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>Carini Caram</title>
    <style type="text/css">
        html, body { height:100%; margin:0; width:100%; overflow:hidden; }
        body { background:#ebd2b4; font:5vw/1 helvetica,arial,freesans,sans-serif; }
        .puk { background:#603c11; border-radius:50%; color:#fff; cursor:pointer; display:block; height:2em; line-height:2em; width:2em; text-align:center; position:absolute; left:0; top:0; }
        .jack { background:#11070b; }
        .hide { display:none; }
    </style>	
</head>

<body>
    <div class="jack puk"></div>
    <div class="puk">◎</div>
    <div class="hide" id="p2">⌘</div>

<script type="text/javascript">
function addHandler(el,evt,fn){ if( el.addEventListener ){ el.addEventListener(evt,fn,false); }else if( el.attachEvent ){ el.attachEvent('on'+evt,fn); } }
function getComputed(el,style){ if(window.getComputedStyle){ var y=document.defaultView.getComputedStyle(el,null).getPropertyValue(style); }else if(el.currentStyle){ if( style=='width' ){ y=el.getBoundingClientRect().right-el.getBoundingClientRect().left }else if( style=='height' ){ y=el.getBoundingClientRect().bottom-el.getBoundingClientRect().top }else{ var y=el.currentStyle[style] } } return parseFloat(y); }
function getPgOffset(el){ var o=[0,0]; if( el.offsetParent ){ do{ o=[o[0]+el.offsetLeft,o[1]+el.offsetTop]; }while( el=el.offsetParent ) } return [o[0]+document.body.scrollLeft,o[1]+document.body.scrollTop]; } 
function getXY(e){ var xy=[]; if( e.touches && e.touches.length ){ if( e.touches.length>1 ){ xy[0] = (e.touches[0].pageX+e.touches[0].pageX)/2; xy[1] = (e.touches[0].pageY+e.touches[0].pageY)/2;}else{ xy[0] = e.touches[0].pageX; xy[1] = e.touches[0].pageY; } }else{ xy[0] = e.pageX; xy[1] = e.pageY; } return xy; }
var caram;
caram = {
	el:null, xy0:null, xyT:null, obs:[], t1:null, t2:null, mv:null, p2:0,
    size: function(el){
        el.wh = [getComputed(el,'width'), getComputed(el,'height')];
        el.whP = [getComputed(el.P,'width'), getComputed(el.P,'height')];
    },
	init: function(el){
        if( typeof el==='string' ){ el = document.querySelector(el); } if( !el ){ return; }
        el.P = el.parentNode;
        caram.size(el);
        el.xy = [getComputed(el,'left'), getComputed(el,'top')];
        el.v = [0,0];
        if( !el.move ){
            el.onmousedown = caram.touch;
            el.ontouchstart = caram.touch;
            el.xyO = getPgOffset(el);
            el.move = function(xy){
                caram.obs.splice(caram.obs.indexOf(this), 1);// todo - more efficient place to do this?
                var x=xy[0], y=xy[1], r,
                    n, tmp, modn, costheta, vn1, vn2, vt1, vt2; //vector maths for collision: n=normal vector, t=tangential
                if( x<=0-this.xyO[0] ){ x=0-this.xyO[0]; r=[-1,0]; }
                else if( x>=this.whP[0]-this.wh[0]-this.xyO[0] ){ x=this.whP[0]-this.wh[0]-this.xyO[0]; r=[1,0]; }
                if( y<=0-this.xyO[1] ){ y=0-this.xyO[1]; r=[0,-1]; }
                else if( y>=this.whP[1]-this.wh[1]-this.xyO[1] ){ y=this.whP[1]-this.wh[1]-this.xyO[1]; r=[0,1]; }
                if( !r ){
                    for( var o in caram.obs ){
                        if( Math.abs(x-caram.obs[o].xy[0])<this.wh[0] && Math.abs(y-caram.obs[o].xy[1])<this.wh[1] ){
                            if( Math.sqrt(Math.pow(x-caram.obs[o].xy[0],2) + Math.pow(y-caram.obs[o].xy[1],2))<this.wh[0] ){
                                n = [this.xy[0]-caram.obs[o].xy[0], this.xy[1]-caram.obs[o].xy[1]];
                                tmp = Math.sqrt(Math.pow(n[0],2) + Math.pow(n[1],2));
                                n = [n[0]/tmp, n[1]/tmp];
                                modn = Math.sqrt((n[0]*n[0])+(n[1]*n[1]));
                                costheta = Math.cos(Math.atan((caram.obs[o].v[1]-this.v[1])/(caram.obs[o].v[0]-this.v[0])));
                                vn1 = Math.sqrt(Math.pow(this.v[0],2)+Math.pow(this.v[1],2)) * modn * costheta;
                                vn1 = [-vn1*n[0], -vn1*n[1]];
                                vn2 = Math.sqrt(Math.pow(caram.obs[o].v[0],2)+Math.pow(caram.obs[o].v[1],2)) * modn * costheta;
                                vn2 = [-vn2*n[0], -vn2*n[1]];
                                vt1 = [vn1[0]-this.v[0], vn1[1]-this.v[1]];
                                vt2 = [vn2[0]-caram.obs[o].v[0], vn2[1]-caram.obs[o].v[1]];
                                this.v = [vt1[0]+vn2[0], vt1[1]+vn2[1]];
                                caram.obs[o].v = [vt2[0]+vn1[0], vt2[1]+vn1[1]];
                                clearTimeout(caram.obs[o].t); caram.obs[o].drop();
                            }
                        }
                    }
                }
                this.xy = [x,y];
                this.style.left = x+'px';
                this.style.top = y+'px';
                caram.obs.push(this);// todo - more efficient place to do this?
                return r;
            };
            el.drop = function(){
                var f = 0.98, r;
                this.v = [this.v[0]*f, this.v[1]*f]; //v=u+at
                r = this.move([this.xy[0]+this.v[0], this.xy[1]+this.v[1]]);
                if( r ){
                    if( r[0] ){ this.v = [-this.v[0], this.v[1]]; }
                    if( r[1] ){ this.v = [this.v[0], -this.v[1]]; }
                }
                if( Math.abs(this.v[0])+Math.abs(this.v[1]) < 0.5 ){ clearTimeout(this.t); return; }
                this.t = setTimeout(function(){ el.drop(); }, 23);
                return false;
            };
        }
	},
	touch: function(e){
		e = e || window.event;
		caram.el = this;
        caram.t1 = caram.t2;
		caram.t2 = e.timeStamp;
        clearTimeout(caram.el.t);
        caram.el.v = [0,0];
		caram.xy0 = caram.el.xy;
        caram.xyT = getXY(e);
		if( e.type==='touchstart' ){
            caram.el.ontouchmove = caram.drag;
            caram.el.onmousedown = null;
            caram.el.ontouchend = function(){
                caram.el.ontouchmove = null;
                caram.el.ontouchend = null;
                caram.release();
            };
        }else{
            document.onmousemove = caram.drag;
            document.onmouseup = function(){
                document.onmousemove = null;
                document.onmouseup = null;
                caram.release();
            };
        }
		return false;
	},
	drag: function(e){
		e = e || window.event;
        caram.mv = 1;
        if( e.preventDefault ){ e.preventDefault(); }else{ e.returnValue=false; }
        var xyE = getXY(e), 
            xy = [caram.xy0[0]+xyE[0]-caram.xyT[0], caram.xy0[1]+xyE[1]-caram.xyT[1]];
        caram.el.v = [(xy[0]-caram.el.xy[0]),(xy[1]-caram.el.xy[1])];
        caram.el.move(xy);
		return false;
	},
	release: function(){
        if( !caram.mv ){/* must be a tap */
            if( caram.t2-caram.t1<300 ){/* double tap */
                var p2 = document.getElementById('p2');
                if( !caram.p2 ){
                    caram.p2 = 1;
                    p2.className = 'puk';
                    caram.init(p2);
                    caram.obs.push(p2);
                }else{
                    caram.p2 = 0;
                    p2.className = 'hide';
                    caram.obs.splice(caram.obs.indexOf(p2), 1);
                }
            }
            caram.reset();
        }else{
            caram.el.drop();
            caram.el = null;
        }
        caram.mv = 0;
	},
	reset: function(){
        var puks = caram.obs.slice();
        for( var o in puks ){
            clearTimeout(puks[o].t);
            if( puks[o].className.indexOf('jack')>-1 ){
                puks[o].move([(puks[o].whP[0]/2)-(puks[o].wh[0]/2), puks[o].wh[1]]);
            }else{
                puks[o].move([puks[o].wh[0]+(Math.random()*(puks[o].whP[0]-(puks[o].wh[0]*3))), (puks[o].wh[1]*2)+(Math.random()*puks[o].wh[1]*3)]);
            }
	    }
	}
};

var i, els = document.querySelectorAll('.puk');
for( i=0; i<els.length; ++i ){ 
    var el = els[i];
    caram.init(el);
    caram.obs.push(el);
    addHandler(window,'resize',function(){
        caram.size(el); 
    });
}
caram.reset();
</script>
</body>
</html>
